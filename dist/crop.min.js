!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.Crop=i()}(this,function(){"use strict";function t(t,i){function e(){i(),t.removeEventListener(s,e)}var n=arguments.length<=2||void 0===arguments[2]?0:arguments[2];s?t.addEventListener(s,e):setTimeout(i,n)}Object.assign=Object.assign||function(t){if(void 0===t||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),e=1;e<arguments.length;e++){var n=arguments[e];if(void 0!==n&&null!==n)for(var h in n)n.hasOwnProperty(h)&&(i[h]=n[h])}return i};var i=function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")},e=function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function, not "+typeof i);t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i&&(Object.setPrototypeOf?Object.setPrototypeOf(t,i):t.__proto__=i)},n=function(t,i){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!i||"object"!=typeof i&&"function"!=typeof i?t:i},h=function(){function t(){i(this,t),this._queue=[]}return t.prototype.on=function(t,i){return this._queue[t]=this._queue[t]||[],this._queue[t].push(i),this},t.prototype.off=function(t,i){if(this._queue[t]){var e="undefined"==typeof i?-2:this._queue[t].indexOf(i);e===-2?delete this._queue[t]:e!==-1&&this._queue[t].splice(e,1),this._queue[t]&&0==this._queue[t].length&&delete this._queue[t]}return this},t.prototype.has=function(t){return!!this._queue[t]},t.prototype.trigger=function(t){if(this._queue[t]){for(var i=arguments.length,e=Array(i>1?i-1:0),n=1;n<i;n++)e[n-1]=arguments[n];for(var h=this._queue[t],o=Array.isArray(h),s=0,h=o?h:h[Symbol.iterator]();;){var a;if(o){if(s>=h.length)break;a=h[s++]}else{if(s=h.next(),s.done)break;a=s.value}var c=a;c.apply(this,e)}}return this},t}(),o=function(){function t(e,n){i(this,t),this._trigger=e,this.quality=n/100,this.busy=!1,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}return t.prototype.writeFile=function(t){this.file={},this.fileKey="",this.fileName=""!=t.type&&t.name.indexOf(".")!=-1?t.name:t.name+".jpg",this.angle=0,this.mime=t.type||"image/jpeg",this.busy=!0,this._getImage(t,function(t){this.fileKey="n",this.file[this.fileKey]=t,this.busy=!1,this._trigger("_readFile",t)})},t.prototype.cropFile=function(t,i,e,n,h,o){return this.file&&this.file[this.fileKey]?(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.width=h,this.canvas.height=o,this.ctx.drawImage(this.file[this.fileKey],t,i,e,n),this.canvas.toDataURL(this.mime,this.quality)):void this._trigger("error",-1,"原图丢失, 请重新选择图片!")},t.prototype.rotate=function(){if(this.file&&this.file.n)if(this.angle=(this.angle+90)%360,this.fileKey=0==this.angle?"n":90==this.angle?"e":180==this.angle?"s":"w",this.busy=!0,this.file[this.fileKey])this.busy=!1,this._trigger("_readFile",this.file[this.fileKey]);else{var t=0==this.angle||180==this.angle?this.file.n.width:this.file.n.height,i=0==this.angle||180==this.angle?this.file.n.height:this.file.n.width;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.width=t,this.canvas.height=i,this.ctx.rotate(this.angle*Math.PI/180),this.ctx.drawImage(this.file.n,180==this.angle?-t:270==this.angle?-i:0,90==this.angle?-t:180==this.angle?-i:0),this._getImage(this.canvas.toDataURL(this.mime,1),function(t){this.file[this.fileKey]=t,this.busy=!1,this._trigger("_readFile",t)})}else this._trigger("error",-1,"原图丢失, 请重新选择图片!")},t.prototype._getImage=function(t,i){var e=this,n=new Image;if("string"==typeof t)n.src=t;else{var h=new FileReader;h.onload=function(t){n.src=t.target.result},h.readAsDataURL(t)}n.addEventListener("load",function(){0==n.width||0==n.height?e._trigger("error",3,"文件读取失败, 请重新选择图片!"):i.call(e,n)}),n.addEventListener("error",function(){this._trigger("error",4,"文件拒绝访问, 请重新选择图片!")})},t}(),s=function(){var t=document.createElement("div"),i={animation:"animationend",webkitAnimation:"webkitAnimationEnd",msAnimation:"MSAnimationEnd",oAnimation:"oanimationend"};for(var e in i)if(void 0!==t.style[e])return i[e];return null}(),a="ontouchstart"in window&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),c=function(){function t(e,n){i(this,t),this.elem=e,this.handler=n,a?(this.events={touchStart:this.onTouchStart.bind(this),touchMove:this.onTouchMove.bind(this),touchEnd:this.onTouchEnd.bind(this),click:function(t){t.stopPropagation()}},this.cachedX=null,this.cachedY=null,this.currX=null,this.currY=null,this.time=null,e.addEventListener("touchstart",this.events.touchStart,!1),e.addEventListener("touchmove",this.events.touchMove,!1),e.addEventListener("touchend",this.events.touchEnd,!1),e.addEventListener("click",this.events.click,!1)):e.addEventListener("click",n,!1)}return t.prototype.onTouchStart=function(t){t.touches.length>1||(this.cachedX=this.currX=t.touches[0].pageX,this.cachedY=this.currY=t.touches[0].pageY,this.time=Date.now())},t.prototype.onTouchMove=function(t){null!=this.cachedX&&(this.currX=t.touches[0].pageX,this.currY=t.touches[0].pageY)},t.prototype.onTouchEnd=function(t){null!=this.cachedX&&(this.cachedX>=this.currX-30&&this.cachedX<=this.currX+30&&this.cachedY>=this.currY-30&&this.cachedY<=this.currY+30&&this.time+250-Date.now()>=0&&(t.preventDefault(),this.handler()),this.cachedX=null)},t.prototype.destroy=function(){a?(this.elem.removeEventListener("touchstart",this.events.touchStart),this.elem.removeEventListener("touchmove",this.events.touchMove),this.elem.removeEventListener("touchend",this.events.touchEnd),this.elem.removeEventListener("click",this.events.click)):this.elem.removeEventListener("click",this.handler)},t}(),r='<div class="head"><a class="zoom-in">放大</a> <a class="zoom-out">缩小</a> <a class="rotate">旋转</a></div><div class="panel"><canvas></canvas></div><div class="foot"><a class="cancel">取消</a> <a class="done">选取</a></div><div class="loading"><ul class="spinner"><li></li><li></li><li></li><li></li><li></li></ul></div>',g="ontouchstart"in window&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),f=function(){function e(t,n){i(this,e),this._trigger=t,this.options=n,this.options.cropRatio=this.options.cropWidth/this.options.cropHeight,this.elem=null,this.config={},this.tapEventCache={},this.eventCache={touchStart:this._onTouchStart.bind(this),touchMove:this._onTouchMove.bind(this),touchEnd:this._onTouchEnd.bind(this),resize:this._onResize.bind(this)}}return e.prototype.setImage=function(t){this.elem||(this.elem=document.createElement("div"),this.elem.classList.add("m-crop-image-canvas"),this.elem.innerHTML=r,document.body.appendChild(this.elem),this.canvas=this.elem.querySelector("canvas"),this.ctx=this.canvas.getContext("2d"),this.loading=this.elem.querySelector(".loading"),this._listener(!0),this._onResize()),this.loading.style.display="none",this.image=t,this.config.image={x:0,y:0,width:t.width,height:t.height,ratio:t.width/t.height},this._reset(),this._draw()},e.prototype._listener=function(t){var i=t?"addEventListener":"removeEventListener";t?(this.tapEventCache.zoomIn=new c(this.elem.querySelector(".zoom-in"),this._zoom.bind(this,!0)),this.tapEventCache.zoomOut=new c(this.elem.querySelector(".zoom-out"),this._zoom.bind(this,!1)),this.tapEventCache.rotate=new c(this.elem.querySelector(".rotate"),this._rotate.bind(this)),this.tapEventCache.cancel=new c(this.elem.querySelector(".cancel"),this._cancel.bind(this)),this.tapEventCache.done=new c(this.elem.querySelector(".done"),this._done.bind(this))):(this.tapEventCache.zoomIn.destroy(),this.tapEventCache.zoomOut.destroy(),this.tapEventCache.rotate.destroy(),this.tapEventCache.cancel.destroy(),this.tapEventCache.done.destroy()),this.canvas[i](g?"touchstart":"mousedown",this.eventCache.touchStart,!1),this.canvas[i](g?"touchmove":"mousemove",this.eventCache.touchMove,!1),g?this.canvas[i]("touchend",this.eventCache.touchEnd,!1):window[i]("mouseup",this.eventCache.touchEnd,!1),window[i]("resize",this.eventCache.resize)},e.prototype._rotate=function(){this.loading.style.display="block",this._trigger("_rotate")},e.prototype._zoom=function(t){if(this.image){var i=this.config.image.width,e=this.config.image.height,n=t?1+this.options.zoomRatio:1/(1+this.options.zoomRatio);this.config.image.width=Math.round(i*n),this.config.image.height=Math.round(e*n),this.config.image.x-=Math.floor((this.config.image.width-i)/2),this.config.image.y-=Math.floor((this.config.image.height-e)/2),this._draw()}},e.prototype._done=function(){var t=this.config.image,i=this.config.area,e=this.options.cropWidth/i.width,n=this.options.cropHeight/i.height,h=Math.floor((t.x-i.x)*e),o=Math.floor((t.y-i.y)*n),s=Math.round(t.width*e),a=Math.round(t.height*n);this._trigger("_crop",h,o,s,a,this.options.cropWidth,this.options.cropHeight),this._cancel()},e.prototype._cancel=function(){var i=this;this._listener(!1),this.elem.classList.add("z-close"),t(this.elem,function(){document.body.removeChild(i.elem),i.elem=null})},e.prototype._verifyConfig=function(){this.config.image.x+this.config.image.width<this.config.area.x+this.config.area.width+1&&(this.config.image.x=this.config.area.x+this.config.area.width-this.config.image.width+1),this.config.image.x>this.config.area.x&&(this.config.image.x=this.config.area.x),this.config.image.y+this.config.image.height<this.config.area.y+this.config.area.height+1&&(this.config.image.y=this.config.area.y+this.config.area.height-this.config.image.height+1),this.config.image.y>this.config.area.y&&(this.config.image.y=this.config.area.y),this.config.image.width<this.config.area.width&&(this.config.image.width=this.config.area.width,this.config.image.height=Math.round(this.config.area.width/this.config.image.ratio)),this.config.image.height<this.config.area.height&&(this.config.image.height=this.config.area.height,this.config.image.width=Math.round(this.config.area.height*this.config.image.ratio))},e.prototype._reset=function(){this.image&&(this.image.width>this.config.canvas.width?(this.config.image.width=this.config.canvas.width,this.config.image.height=this.config.canvas.width/this.config.image.ratio):this.image.width<this.config.area.width&&(this.config.image.width=this.config.area.width,this.config.image.height=this.config.area.width/this.config.image.ratio),this.image.height>this.config.canvas.height?(this.config.image.height=this.config.canvas.height,this.config.image.width=this.config.canvas.height*this.config.image.ratio):this.image.height<this.config.area.height&&(this.config.image.height=this.config.area.height,this.config.image.width=this.config.area.height*this.config.image.ratio),this.config.image.width=Math.round(this.config.image.width),this.config.image.height=Math.round(this.config.image.height),this.config.image.x=Math.floor((this.config.canvas.width-this.config.image.width)/2),this.config.image.y=Math.floor((this.config.canvas.height-this.config.image.height)/2))},e.prototype._draw=function(){this.image&&(this._verifyConfig(),this.ctx.clearRect(0,0,this.config.canvas.width,this.config.canvas.height),this.ctx.drawImage(this.image,this.config.image.x,this.config.image.y,this.config.image.width,this.config.image.height),this.ctx.save(),this.ctx.fillStyle=this.options.background,this.ctx.fillRect(0,0,this.config.canvas.width,this.config.canvas.height),this.ctx.restore(),this.ctx.save(),this.ctx.beginPath(),this.ctx.strokeStyle=this.options.borderColor,this.ctx.lineWidth=this.options.borderSize,this.ctx.rect(this.config.area.x,this.config.area.y,this.config.area.width,this.config.area.height),this.options.borderSize>0&&this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.image,this.config.image.x,this.config.image.y,this.config.image.width,this.config.image.height),this.ctx.restore())},e.prototype._getCanvasOffset=function(){var t=this.canvas.getBoundingClientRect(),i=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,e=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,n=document.documentElement.clientTop||document.body.clientTop||0,h=document.documentElement.clientLeft||document.body.clientLeft||0;return{x:Math.round(t.left+e-h),y:Math.round(t.top+i-n)}},e.prototype._getEventXY=function(t){var i=this;return(t.touches?Array.prototype.slice.call(t.touches):[t]).map(function(t){return{x:t.screenX-i.config.canvas.offset.x,y:t.screenY-i.config.canvas.offset.y}})},e.prototype._getTouchDistance=function(t){return 2==t.length?Math.sqrt((t[1].x-t[0].x)*(t[1].x-t[0].x)+(t[1].y-t[0].y)*(t[1].y-t[0].y)):0},e.prototype._onTouchStart=function(t){if(t.stopPropagation(),t.preventDefault(),this.image&&!(t.touches&&t.touches.length>2)){var i=this._getEventXY(t);this.touch={state:!0,points:i,distance:this._getTouchDistance(i)}}},e.prototype._onTouchMove=function(t){var i=this;t.stopPropagation(),t.preventDefault(),this.touch.state&&setTimeout(function(){var e=i._getEventXY(t);if(t.touches&&1!=t.touches.length){var n=i._getTouchDistance(e)-i.touch.distance;Math.abs(n)>i.options.gap&&(i.touch.distance+=n,i._zoom(n>0))}else i.config.image.x+=e[0].x-i.touch.points[0].x,i.config.image.y+=e[0].y-i.touch.points[0].y,i.touch.points[0].x=e[0].x,i.touch.points[0].y=e[0].y,i._draw()},0)},e.prototype._onTouchEnd=function(t){t.stopPropagation(),this.touch.state&&(this.touch.state=!1)},e.prototype._onResize=function(){var t=this.canvas.clientWidth,i=this.canvas.clientHeight,e=.7*(t<i?t:i),n=e/this.options.cropRatio;n>.6*i&&(n=.6*i,e=n*this.options.cropRatio),e=Math.round(e),n=Math.round(n),this.config.canvas={width:t,height:i,offset:this._getCanvasOffset()},this.config.area={x:Math.floor(t/2-e/2),y:Math.floor(i/2-n/2),width:e,height:n},this.touch={state:!1,points:null,distance:0},this.canvas.width=t,this.canvas.height=i,this._reset(),this._draw()},e}(),l=function(t){function h(e,s){i(this,h);var a=n(this,t.call(this));return e&&/input/i.test(e.tagName)&&/file/i.test(e.type)?(a.elem=e,a.elem.value=null,a.file=new o(a.trigger.bind(a),s.quality||80),delete s.quality,a.canvas=new f(a.trigger.bind(a),Object.assign({cropWidth:200,cropHeight:200,zoomRatio:.1,gap:20,borderSize:1,borderColor:"#fff",background:"rgba(0,0,0,.8)"},s)),a._bindEvents(),a._bindFileChange()):a.trigger("error",100,"请绑定正确的file标签"),a}return e(h,t),h.prototype._bindEvents=function(){var t=this;this.on("_readFile",function(i){t.elem.value=null,t.canvas.setImage(i)}).on("_rotate",function(){t.file.rotate()}).on("_crop",function(i,e,n,h,o,s){var a=t.file.cropFile(i,e,n,h,o,s);t.trigger("crop",a,t.file.fileName)})},h.prototype._bindFileChange=function(){var t=this;this.elem.addEventListener("change",function(i){t.file.busy?t.trigger("error",1,"请勿重复操作。"):i.target.files?""==i.target.files[0].type||/image\/(jpeg|png|gif|bmp|tiff)/.test(i.target.files[0].type)?t.file.writeFile(i.target.files[0]):t.trigger("error",2,"请上传正确格式的图片, 仅支持[jpeg,png,gif,bmp,tiff)格式的图片!"):t.trigger("error",1,"浏览器缺陷, 不支持FileList!")})},h}(h);return l});